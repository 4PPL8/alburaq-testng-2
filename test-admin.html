<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .product-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>Admin System Test - Data Persistence & Undo Functionality</h1>
    
    <div class="container">
        <h2>System Status</h2>
        <div id="status" class="status info">Loading system status...</div>
        <div id="undoStatus" class="status info">No changes to undo</div>
    </div>

    <div class="container">
        <h2>Add New Product</h2>
        <form id="productForm">
            <div class="input-group">
                <label for="name">Product Name:</label>
                <input type="text" id="name" required>
            </div>
            <div class="input-group">
                <label for="category">Category:</label>
                <select id="category" required>
                    <option value="">Select Category</option>
                    <option value="Cosmetics & Personal Care">Cosmetics & Personal Care</option>
                    <option value="Razors">Razors</option>
                    <option value="Toothbrush">Toothbrush</option>
                    <option value="Agarbatti (Incense Sticks)">Agarbatti (Incense Sticks)</option>
                    <option value="Natural / Herbal Products">Natural / Herbal Products</option>
                    <option value="Adhesive Tape">Adhesive Tape</option>
                    <option value="PVC Tape">PVC Tape</option>
                    <option value="Stationery">Stationery</option>
                    <option value="Stationery Tapes">Stationery Tapes</option>
                    <option value="Baby Products (Soothers)">Baby Products (Soothers)</option>
                    <option value="Cleaning Products">Cleaning Products</option>
                    <option value="Pest Control">Pest Control</option>
                    <option value="Craft Supplies">Craft Supplies</option>
                </select>
            </div>
            <div class="input-group">
                <label for="description">Description:</label>
                <textarea id="description" rows="3" required></textarea>
            </div>
            <div class="input-group">
                <label for="image">Image URL:</label>
                <input type="url" id="image" placeholder="https://example.com/image.jpg" required>
            </div>
            <div class="input-group">
                <label for="features">Features (comma-separated):</label>
                <input type="text" id="features" placeholder="Feature 1, Feature 2, Feature 3">
            </div>
            <button type="submit" class="button success">Add Product</button>
        </form>
    </div>

    <div class="container">
        <h2>Actions</h2>
        <button id="undoBtn" class="button" disabled>Undo Last Change</button>
        <button id="clearBtn" class="button danger">Clear All Data</button>
        <button id="refreshBtn" class="button">Refresh Display</button>
    </div>

    <div class="container">
        <h2>Products (<span id="productCount">0</span>)</h2>
        <div id="productList" class="product-list">
            <!-- Products will be displayed here -->
        </div>
    </div>

    <script>
        // Simple data persistence service for testing
        class TestDataService {
            constructor() {
                this.storageKey = 'alburaq_products_data';
                this.changeHistoryKey = 'alburaq_change_history';
                this.loadChangeHistory();
            }

            loadProducts() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored).products || [] : [];
                } catch (error) {
                    console.error('Error loading products:', error);
                    return [];
                }
            }

            saveProducts(products) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify({ products }));
                    this.triggerStorageEvent();
                    return { success: true, message: 'Products saved successfully' };
                } catch (error) {
                    console.error('Error saving products:', error);
                    return { success: false, message: 'Failed to save products' };
                }
            }

            addChange(change) {
                const newChange = {
                    ...change,
                    id: `change_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    timestamp: Date.now()
                };

                this.changeHistory.unshift(newChange);
                
                if (this.changeHistory.length > 50) {
                    this.changeHistory = this.changeHistory.slice(0, 50);
                }

                localStorage.setItem(this.changeHistoryKey, JSON.stringify(this.changeHistory));
            }

            getLastChange() {
                return this.changeHistory.length > 0 ? this.changeHistory[0] : null;
            }

            undoLastChange() {
                if (this.changeHistory.length === 0) {
                    return { success: false, message: 'No changes to undo' };
                }

                const lastChange = this.changeHistory.shift();
                localStorage.setItem(this.changeHistoryKey, JSON.stringify(this.changeHistory));

                if (lastChange.action === 'delete' && lastChange.previousData) {
                    return {
                        success: true,
                        message: `Undid deletion of ${lastChange.previousData.name}`,
                        restoredData: [lastChange.previousData]
                    };
                } else if (lastChange.action === 'add' && lastChange.previousData) {
                    return {
                        success: true,
                        message: `Undid addition of ${lastChange.previousData.name}`,
                        restoredData: []
                    };
                } else if (lastChange.action === 'update' && lastChange.previousData) {
                    return {
                        success: true,
                        message: `Undid update of ${lastChange.previousData.name}`,
                        restoredData: [lastChange.previousData]
                    };
                }

                return { success: false, message: 'Unable to undo this change' };
            }

            loadChangeHistory() {
                try {
                    const stored = localStorage.getItem(this.changeHistoryKey);
                    this.changeHistory = stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Error loading change history:', error);
                    this.changeHistory = [];
                }
            }

            clearChangeHistory() {
                this.changeHistory = [];
                localStorage.removeItem(this.changeHistoryKey);
            }

            triggerStorageEvent() {
                window.dispatchEvent(new CustomEvent('products_updated'));
            }
        }

        // Initialize the test system
        const dataService = new TestDataService();
        let products = [];

        // DOM elements
        const statusDiv = document.getElementById('status');
        const undoStatusDiv = document.getElementById('undoStatus');
        const undoBtn = document.getElementById('undoBtn');
        const clearBtn = document.getElementById('clearBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const productForm = document.getElementById('productForm');
        const productList = document.getElementById('productList');
        const productCount = document.getElementById('productCount');

        // Load initial data
        function loadProducts() {
            products = dataService.loadProducts();
            if (products.length === 0) {
                // Add some sample products if none exist
                const sampleProducts = [
                    {
                        id: '1',
                        name: 'Sample Product 1',
                        category: 'Cosmetics & Personal Care',
                        description: 'This is a sample product for testing.',
                        image: 'https://placehold.co/400x400/CCCCCC/000000?text=Sample+1',
                        features: ['Feature 1', 'Feature 2', 'Feature 3']
                    },
                    {
                        id: '2',
                        name: 'Sample Product 2',
                        category: 'Razors',
                        description: 'Another sample product for testing.',
                        image: 'https://placehold.co/400x400/CCCCCC/000000?text=Sample+2',
                        features: ['Quality', 'Durability', 'Performance']
                    }
                ];
                products = sampleProducts;
                dataService.saveProducts(products);
            }
            updateDisplay();
            updateUndoStatus();
        }

        // Update the display
        function updateDisplay() {
            productCount.textContent = products.length;
            
            productList.innerHTML = products.map(product => `
                <div class="product-card">
                    <img src="${product.image}" alt="${product.name}" onerror="this.src='https://placehold.co/400x400/CCCCCC/000000?text=No+Image'">
                    <h3>${product.name}</h3>
                    <p><strong>Category:</strong> ${product.category}</p>
                    <p>${product.description}</p>
                    <p><strong>Features:</strong> ${product.features.join(', ')}</p>
                    <button class="button danger" onclick="deleteProduct('${product.id}')">Delete</button>
                </div>
            `).join('');
        }

        // Update undo status
        function updateUndoStatus() {
            const lastChange = dataService.getLastChange();
            if (lastChange) {
                undoStatusDiv.textContent = `Last change: ${lastChange.description}`;
                undoStatusDiv.className = 'status info';
                undoBtn.disabled = false;
            } else {
                undoStatusDiv.textContent = 'No changes to undo';
                undoStatusDiv.className = 'status info';
                undoBtn.disabled = true;
            }
        }

        // Add product
        function addProduct(productData) {
            const newProduct = {
                ...productData,
                id: Date.now().toString(),
                features: productData.features ? productData.features.split(',').map(f => f.trim()).filter(f => f) : []
            };

            dataService.addChange({
                action: 'add',
                previousData: newProduct,
                newData: newProduct,
                description: `Added product: ${newProduct.name}`
            });

            products.push(newProduct);
            dataService.saveProducts(products);
            updateDisplay();
            updateUndoStatus();
            
            statusDiv.textContent = `Product "${newProduct.name}" added successfully!`;
            statusDiv.className = 'status success';
        }

        // Delete product
        function deleteProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            dataService.addChange({
                action: 'delete',
                previousData: product,
                newData: undefined,
                description: `Deleted product: ${product.name}`
            });

            products = products.filter(p => p.id !== id);
            dataService.saveProducts(products);
            updateDisplay();
            updateUndoStatus();
            
            statusDiv.textContent = `Product "${product.name}" deleted successfully!`;
            statusDiv.className = 'status success';
        }

        // Undo last change
        function undoLastChange() {
            const undoResult = dataService.undoLastChange();
            
            if (undoResult.success && undoResult.restoredData !== undefined) {
                if (undoResult.restoredData.length === 0) {
                    // This was an addition that needs to be removed
                    const lastChange = dataService.getLastChange();
                    if (lastChange && lastChange.previousData) {
                        products = products.filter(p => p.id !== lastChange.previousData.id);
                    }
                } else {
                    // This was a deletion or update that needs to be restored
                    undoResult.restoredData.forEach(restoredProduct => {
                        const existingIndex = products.findIndex(p => p.id === restoredProduct.id);
                        if (existingIndex >= 0) {
                            products[existingIndex] = restoredProduct;
                        } else {
                            products.push(restoredProduct);
                        }
                    });
                }
                
                dataService.saveProducts(products);
                updateDisplay();
                updateUndoStatus();
                
                statusDiv.textContent = undoResult.message;
                statusDiv.className = 'status success';
            } else {
                statusDiv.textContent = undoResult.message;
                statusDiv.className = 'status error';
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                dataService.clearChangeHistory();
                products = [];
                dataService.saveProducts(products);
                updateDisplay();
                updateUndoStatus();
                
                statusDiv.textContent = 'All data cleared successfully!';
                statusDiv.className = 'status success';
            }
        }

        // Event listeners
        productForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(productForm);
            const productData = {
                name: formData.get('name') || document.getElementById('name').value,
                category: formData.get('category') || document.getElementById('category').value,
                description: formData.get('description') || document.getElementById('description').value,
                image: formData.get('image') || document.getElementById('image').value,
                features: document.getElementById('features').value
            };

            addProduct(productData);
            productForm.reset();
        });

        undoBtn.addEventListener('click', undoLastChange);
        clearBtn.addEventListener('click', clearAllData);
        refreshBtn.addEventListener('click', () => {
            loadProducts();
            statusDiv.textContent = 'Display refreshed!';
            statusDiv.className = 'status info';
        });

        // Listen for storage events (for cross-tab sync)
        window.addEventListener('storage', (event) => {
            if (event.key === dataService.storageKey) {
                loadProducts();
            }
        });

        window.addEventListener('products_updated', () => {
            loadProducts();
        });

        // Initialize
        loadProducts();
        statusDiv.textContent = 'System ready! You can now add, delete, and undo changes.';
        statusDiv.className = 'status success';
    </script>
</body>
</html> 